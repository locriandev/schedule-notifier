apiVersion: batch/v1
kind: Job
metadata:
  generateName: weekly-schedule-test-
  namespace: weekly-schedule-notifier
spec:
  template:
    metadata:
      labels:
        app: weekly-schedule-notifier
    spec:
      restartPolicy: OnFailure
      containers:
      - name: schedule-notifier
        image: registry.access.redhat.com/ubi9/python-311:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          pip install -q click slack-sdk
          python /app/schedule_notifier.py --notify-slack
        env:
        - name: SLACK_CHANNEL
          valueFrom:
            configMapKeyRef:
              name: weekly-schedule-config
              key: SLACK_CHANNEL
        - name: SCHEMA
          valueFrom:
            configMapKeyRef:
              name: weekly-schedule-config
              key: SCHEMA
        - name: SLACK_USER_MAPPING
          valueFrom:
            configMapKeyRef:
              name: weekly-schedule-config
              key: SLACK_USER_MAPPING
        - name: SLACK_USER_GROUP_ID
          valueFrom:
            configMapKeyRef:
              name: weekly-schedule-config
              key: SLACK_USER_GROUP_ID
        - name: SLACK_TOKEN
          valueFrom:
            secretKeyRef:
              name: weekly-schedule-secret
              key: SLACK_TOKEN
        volumeMounts:
        - name: app-code
          mountPath: /app
        - name: schedule-config
          mountPath: /config
      volumes:
      - name: app-code
        configMap:
          name: weekly-schedule-app
      - name: schedule-config
        configMap:
          name: weekly-schedule-config
          items:
          - key: schema.txt
            path: schema.txt
